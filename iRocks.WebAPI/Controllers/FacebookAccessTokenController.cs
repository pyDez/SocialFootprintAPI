using Facebook;
using iRocks.DataLayer;
using iRocks.WebAPI.Models;
using iRocks.WebAPI.Services;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Web.Http;
using iRocks.AI;

namespace iRocks.WebAPI.Controllers
{
    public class FacebookAccessTokenController : BaseApiController
    {
        private IIRocksIdentityService _identityService;
        private ISocialNetworkToDbParser _facebookToDBUpdater;
        public FacebookAccessTokenController(IUserRepository repository, IIRocksIdentityService IdentityService, ISocialNetworkToDbParser facebookToDBUpdater)
            : base(repository)
        {
            _identityService = IdentityService;
            _facebookToDBUpdater = facebookToDBUpdater;
        }

        public HttpResponseMessage Post([FromBody]string accessToken)
        {
            try
            {
                var client = new FacebookClient(accessToken);
                dynamic result = client.Get("me", new { fields = "first_name,last_name,email,id,posts.fields(id,from,created_time,link,message,name,object_id,picture,privacy,source,status_type,story,type,updated_time).limit(25),friends.fields(first_name,last_name,email,id).limit(25),home" });
                //dynamic result = Newtonsoft.Json.JsonConvert.DeserializeObject<dynamic>("{  \"first_name\": \"Pierre-Yves\",  \"last_name\": \"Dezaunay\",  \"id\": \"100000420201795\",  \"posts\": {    \"data\": [      {        \"id\": \"100000420201795_765999596757373\",        \"from\": {          \"name\": \"Pierre-Yves Dezaunay\",          \"id\": \"100000420201795\"        },        \"created_time\": \"2014-04-01T10:17:18+0000\",        \"message\": \"Il n'y a qu'en maths qu'un plus un font deux!\",        \"privacy\": {          \"description\": \"Friends; Except: Restricted\",          \"value\": \"ALL_FRIENDS\",          \"friends\": \"\",          \"networks\": \"\",          \"allow\": \"\",          \"deny\": \"\"        },        \"status_type\": \"mobile_status_update\",        \"type\": \"status\",        \"updated_time\": \"2014-04-02T14:57:33+0000\"      },      {        \"id\": \"100000420201795_745060078851325\",        \"from\": {          \"name\": \"Pierre-Yves Dezaunay\",          \"id\": \"100000420201795\"        },        \"created_time\": \"2014-02-22T08:19:44+0000\",        \"link\": \"https://medium.com/p/b84d4011d17e\",        \"name\": \"The Problem With Little White Girls (and Boys)\",        \"picture\": \"https://fbexternal-a.akamaihd.net/safe_image.php?d=AQB06JikNB9DN1ZN&w=154&h=154&url=https%3A%2F%2Fd262ilb51hltx0.cloudfront.net%2Fmax%2F800%2F1%2AzSuVMdBrIUZnl0cY-wWJhw.jpeg\",        \"privacy\": {          \"description\": \"C�line Dezaunay; Except: Restricted\",          \"value\": \"CUSTOM\",          \"friends\": \"SOME_FRIENDS\",          \"networks\": \"\",          \"allow\": \"580655635\",          \"deny\": \"\"        },        \"status_type\": \"shared_story\",        \"story\": \"Pierre-Yves Dezaunay shared a link.\",        \"type\": \"link\",        \"updated_time\": \"2014-02-22T08:19:44+0000\"      },      {        \"id\": \"100000420201795_1432818270267469\",        \"from\": {          \"name\": \"Pierre-Yves Dezaunay\",          \"id\": \"100000420201795\"        },        \"created_time\": \"2013-11-29T20:20:18+0000\",        \"link\": \"https://www.facebook.com/events/1432818270267469/\",        \"privacy\": {          \"value\": \"\"        },        \"story\": \"Pierre-Yves Dezaunay created an event.\",        \"type\": \"link\",        \"updated_time\": \"2013-11-29T20:20:18+0000\"      },      {        \"id\": \"100000420201795_600945833262751\",        \"from\": {          \"name\": \"Pierre-Yves Dezaunay\",          \"id\": \"100000420201795\"        },        \"created_time\": \"2013-05-21T08:35:40+0000\",        \"link\": \"https://www.facebook.com/photo.php?fbid=10200863277404856&set=at.10200782068534685.1073741825.1252037178.100000420201795&type=1&relevant_count=5\",        \"object_id\": \"10200863277404856\",        \"picture\": \"https://fbcdn-photos-c-a.akamaihd.net/hphotos-ak-frc3/t1.0-0/968984_10200863277404856_1173618796_s.jpg\",        \"privacy\": {          \"value\": \"\"        },        \"status_type\": \"tagged_in_photo\",        \"story\": \"Pierre-Yves Dezaunay was tagged in Marie-Anne Alexandre's photos.\",        \"type\": \"photo\",        \"updated_time\": \"2013-05-21T08:35:40+0000\"      },      {        \"id\": \"100000420201795_579984132025588\",        \"from\": {          \"name\": \"Pierre-Yves Dezaunay\",          \"id\": \"100000420201795\"        },        \"created_time\": \"2013-03-31T13:01:30+0000\",        \"message\": \"URGENT : Vend 2 billets d'avions Aller-Retour: Orly - Rome pour ce week-end. Qui est int�ress� ? 350� c'est une affaire en or !\",        \"privacy\": {          \"description\": \"Friends; Except: Restricted\",          \"value\": \"ALL_FRIENDS\",          \"friends\": \"\",          \"networks\": \"\",          \"allow\": \"\",          \"deny\": \"\"        },        \"status_type\": \"mobile_status_update\",        \"type\": \"status\",        \"updated_time\": \"2013-03-31T14:14:02+0000\"      },      {        \"id\": \"100000420201795_563048283719173\",        \"from\": {          \"name\": \"Pierre-Yves Dezaunay\",          \"id\": \"100000420201795\"        },        \"created_time\": \"2013-02-21T18:37:07+0000\",        \"message\": \"Vend 2 billets d'avions Aller-Retour: Orly - Rome du vendredi 5 avril (le soir) au dimanche 7 avril. Qui est int�ress� ?\",        \"privacy\": {          \"description\": \"Friends; Except: Restricted\",          \"value\": \"ALL_FRIENDS\",          \"friends\": \"\",          \"networks\": \"\",          \"allow\": \"\",          \"deny\": \"\"        },        \"status_type\": \"mobile_status_update\",        \"type\": \"status\",        \"updated_time\": \"2013-02-21T18:53:05+0000\"      },      {        \"id\": \"100000420201795_539366062754062\",        \"from\": {          \"name\": \"Pierre-Yves Dezaunay\",          \"id\": \"100000420201795\"        },        \"created_time\": \"2013-01-10T11:55:54+0000\",        \"link\": \"https://www.facebook.com/photo.php?fbid=10151231648553651&set=at.10151231617648651.454359.502083650.100000420201795&type=1&relevant_count=1\",        \"object_id\": \"10151231648553651\",        \"picture\": \"https://fbcdn-photos-g-a.akamaihd.net/hphotos-ak-ash2/t1.0-0/23390_10151231648553651_263737289_s.jpg\",        \"privacy\": {          \"value\": \"\"        },        \"status_type\": \"tagged_in_photo\",        \"story\": \"Pierre-Yves Dezaunay was tagged in Christophe Dullin's photo.\",        \"type\": \"photo\",        \"updated_time\": \"2013-01-10T11:55:54+0000\"      },      {        \"id\": \"100000420201795_495485997142069\",        \"from\": {          \"name\": \"Pierre-Yves Dezaunay\",          \"id\": \"100000420201795\"        },        \"created_time\": \"2012-10-03T21:20:16+0000\",        \"link\": \"https://www.facebook.com/photo.php?fbid=495485973808738&set=a.495485960475406.116336.100000420201795&type=1&relevant_count=1\",        \"object_id\": \"495485973808738\",        \"picture\": \"https://fbcdn-photos-f-a.akamaihd.net/hphotos-ak-frc3/t1.0-0/545362_495485973808738_665022249_s.jpg\",        \"privacy\": {          \"value\": \"\"        },        \"story\": \"Pierre-Yves Dezaunay updated his cover photo.\",        \"type\": \"photo\",        \"updated_time\": \"2012-10-15T20:06:04+0000\"      }    ],    \"paging\": {      \"previous\": \"https://graph.facebook.com/100000420201795/posts?fields=id,from,created_time,link,message,name,object_id,picture,privacy,source,status_type,story,type,updated_time&limit=25&since=1396347438\",      \"next\": \"https://graph.facebook.com/100000420201795/posts?fields=id,from,created_time,link,message,name,object_id,picture,privacy,source,status_type,story,type,updated_time&limit=25&until=1349299215\"    }  },  \"friends\": {    \"data\": [      {        \"first_name\": \"Christophe\",        \"last_name\": \"Dullin\",        \"id\": \"502083650\"      },      {        \"first_name\": \"Agnes\",        \"last_name\": \"Vh\",        \"id\": \"505469721\"      },      {        \"first_name\": \"Pierre-Antoine\",        \"last_name\": \"Montfort\",        \"id\": \"505631748\"      },      {        \"first_name\": \"Aude\",        \"last_name\": \"Boustens\",        \"id\": \"511251147\"      },      {        \"first_name\": \"Bertrand\",        \"last_name\": \"Muslin\",        \"id\": \"511523108\"      },      {        \"first_name\": \"Audrey\",        \"last_name\": \"Ct\",        \"id\": \"515770900\"      },      {        \"first_name\": \"Margaux\",        \"last_name\": \"de Bar\",        \"id\": \"516656829\"      },      {        \"first_name\": \"Sylvain\",        \"last_name\": \"Lct\",        \"id\": \"518344575\"      },      {        \"first_name\": \"Cl�m\",        \"last_name\": \"Chaignaud\",        \"id\": \"520881300\"      },      {        \"first_name\": \"Nicolas\",        \"last_name\": \"Fdin\",        \"id\": \"522210836\"      },      {        \"first_name\": \"Olivier\",        \"last_name\": \"Wadaa\",        \"id\": \"524554349\"      },      {        \"first_name\": \"Alex\",        \"last_name\": \"Guinaudeau\",        \"id\": \"525942017\"      },      {        \"first_name\": \"Lorene\",        \"last_name\": \"Le Bail\",        \"id\": \"528913322\"      },      {        \"first_name\": \"Paul\",        \"last_name\": \"Dbf\",        \"id\": \"532086462\"      },      {        \"first_name\": \"David\",        \"last_name\": \"Bonnin\",        \"id\": \"532398393\"      },      {        \"first_name\": \"Thomas\",        \"last_name\": \"Valleteau\",        \"id\": \"537522354\"      },      {        \"first_name\": \"Claire\",        \"last_name\": \"Lenne\",        \"id\": \"541374206\"      },      {        \"first_name\": \"Camille\",        \"last_name\": \"Lemaire\",        \"id\": \"543317369\"      },      {        \"first_name\": \"Anne-Sophie\",        \"last_name\": \"Valleteau Jacquet\",        \"id\": \"543999841\"      },      {        \"first_name\": \"Marguerite\",        \"last_name\": \"Jaquemin\",        \"id\": \"545433411\"      },      {        \"first_name\": \"Philippe\",        \"last_name\": \"Le Bec\",        \"id\": \"547441535\"      },      {        \"first_name\": \"Fiona\",        \"last_name\": \"Youhou\",        \"id\": \"548234096\"      },      {        \"first_name\": \"S�bastien\",        \"last_name\": \"Faure\",        \"id\": \"550506987\"      },      {        \"first_name\": \"Louis\",        \"last_name\": \"Montfort\",        \"id\": \"551210641\"      },      {        \"first_name\": \"Marie\",        \"last_name\": \"GdA-gds\",        \"id\": \"554006600\"      }    ],    \"paging\": {      \"next\": \"https://graph.facebook.com/100000420201795/friends?fields=first_name,last_name,email,id&limit=25&offset=25&__after_id=554006600\"    }  },  \"home\": {    \"data\": [      {        \"id\": \"511523108_10152408655463109\",        \"from\": {          \"name\": \"Alexandre Briscard Mart�nez\",          \"id\": \"532398393\"        },        \"to\": {          \"data\": [            {              \"name\": \"Bertrand Muslin\",              \"id\": \"511523108\"            }          ]        },        \"message\": \"Happy BBRthday to u!! Bisous :D\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/511523108/posts/10152408655463109\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/511523108/posts/10152408655463109\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"status\",        \"status_type\": \"wall_post\",        \"created_time\": \"2014-04-14T06:30:39+0000\",        \"updated_time\": \"2014-04-14T06:30:39+0000\"      },      {        \"id\": \"792179096_10152775938429097\",        \"from\": {          \"name\": \"Mohammed Husain\",          \"id\": \"532398393\"        },        \"story\": \"Mohammed Husain shared Roby Kurian's status update.\",        \"picture\": \"https://fbcdn-profile-a.akamaihd.net/hprofile-ak-frc3/t1.0-1/c13.12.155.155/s100x100/1982009_10202145052722556_7203407_a.jpg\",        \"link\": \"https://www.facebook.com/roby.kurian.1/posts/10202422268372774\",        \"name\": \"Roby Kurian\",        \"description\": \"????? ???????, ??????????\\n==========================\\n\\n????? ??????????? ??????????? ????????? �????� ???????????????????? ???? ???????? ???????????. ????? ??????? ?????????????????? ??????????? ????????? ?????????? ??????? ?????? ????????. ???????? ???? ??????????????????????. ????????? ??????????? ????????????? ????, ???????? ???????????????????? ??? ?????????????????????????? ? ????? ?????? ???????????? ????????????????. ?????? ??? ???????? ?????. ?????, ?????????? ??? ??????????-????????????????? ???? ??????? ????? ?????????????????????? ???? ???????????. ?????????, ????? ??????-??? ??????????????. ????????????, ?????? ?????? ???????????????, concept driven. ????????? ????? ?????????? ??????????? ????? ????????.\\n\\n10-14 ???? ????? ????????????? ????? ????????? ??????? ???????????????????? ??????????????????????. ?????, ????????? ?????????? ??????? ??????????? ????????????????? ????????????? ???? ????. ????????? ???????????? ??????? ??????? ????? ????? ??????????? ??????-??????????? ????. ?????????? ?????????????? ????????? ????????? ??????????? ????????? ?????????????? ?????. ???????? ???????????????????????? ?????????? ?????? ??????????? ???????????????????????? ? ?????? ?????? ?????????????? ??????? ??? ?????????????????.\\n\\n???????????? ????? ?????????. ??? ?????????? ???????????????? ?????????? ??? ????????? ????????????????? ? ???????? ??????? ??? ???????????? ?????????? ???????. ????????????? ?????? ?????????????????????? ???????????????????? ?????????????? ?????. 2002-? ???????? ??????????? ????? ????? ??????????????????? �?????????? ??????� ????????????????? ??????????????? ?????????????? ??????. ?????? ????????????? ???? ???????????? ???????? ????????????????. ????? ???? ?????, ????? ???, ??? ????? ??????? ????????????????????????? ???????????? ??????? ?????. ???? ??????????? ???? ?????, ???? ?????? ????????? ?????????????. ?????????? ??? 5 ??? ??????? �5 ?????????� ???? ????? ??? ??????????????? ??????? ?????????????????????. ??????? ??????????? ? ????????? ??? ?????? ??????????????? ?????????? ???????? ??????????? ???? ??????????? ????????????? ??? ????????? ????? ???????. ??????????-?????????-??????-????????-????????????-????-????????? ?????????? ??????? ??????-???????????-???????-???????? ?????????? ????? ??? ??????????????? ?????????? ????????. ??? ?????? ??????????? ?????? ???? ????? ????????????. (???????? ??????????? ?????????? ??? ???????? ??????? form-? ????????????????). ?????? ????? ??????????? ??? ????-??? ??? ???????????????????? ?????????????? ?????????? ????? ???. ?????????? ???????????????????????????? ????? ??????????????? ???????? ??????? ?????? ?????????????? �???? ??????? ????� ???? ????? ????? ??????.\\n\\n??????????? ??? ????????. ????? ??? ????????? ???????????? ????????????????? ??????????. ????????? ????? ?????????????? ????????? ????????????? ??????????? �??????????? ???????? ??????????? ????????? ?????� ???? ????????? ????????? ????????????? ???? ?????????????. ?????????? ???????????? ?????? ??????????? ???? ????????? ??????????? �??????�?? ????????????????, ??????????? ?????????????????? ?????? ????????. ??? ???????????????????????? ????? ????? ????????????? ????? ????????????????. (????? ?????? ????? ??????? ??????? ????????????????? ??????? ?????????????. ??????? ???? ????????? ???????????????????????????).\\n\\n???????????? ??????? ?????????????? ??????. ?????, ??????? ??????????????? ?????????????????? ???? ????????? ??????????? ??????????????????????????????? ??????????? ??????? ???????. (???????-????????? ?????). ?????, ??????????? ???????????????????????????? ???????????? ???????????? ??????? ???? ????????????????? ?????????. (? ??????????? ?????????????????????????? ???????).\\n\\n????????????, ???????????????????? ?????? ????? ???????????. ????????? ?????? ?????????? ??????????? ??????????????????? ????????????? ??????? ?????????, �?????????? ???? ????????�. ??????? ???? ???????, ???????? ??? ??????????. ????? ???????????? ???????????????? ???????????? ????????????? ?????????????????? ??????????????. ????????? ??? ????????? ????????????? ??????? ??????? ????????????. ????????????? ???? ??? ???????????????????. ?????, ?????? ?????????????? ?????????? ????? ??? ??????????? ?????????????????????????.\",        \"icon\": \"https://fbstatic-a.akamaihd.net/rsrc.php/v2/yD/r/aS8ecmYRys0.gif\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/792179096/posts/10152775938429097\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/792179096/posts/10152775938429097\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"link\",        \"status_type\": \"shared_story\",        \"application\": {          \"name\": \"Facebook for iPhone\",          \"namespace\": \"fbiphone\",          \"id\": \"6628568379\"        },        \"created_time\": \"2014-04-14T05:13:47+0000\",        \"updated_time\": \"2014-04-14T05:13:47+0000\",        \"likes\": {          \"data\": [            {              \"id\": \"100002815307964\",              \"name\": \"Mumtaz Beegum\"            }          ],          \"paging\": {            \"cursors\": {              \"after\": \"MTAwMDAyODE1MzA3OTY0\",              \"before\": \"MTAwMDAyODE1MzA3OTY0\"            }          }        }      },      {        \"id\": \"511523108_10152407790508109\",        \"from\": {          \"name\": \"Alex Lafosse\",          \"id\": \"532398393\"        },        \"to\": {          \"data\": [            {              \"name\": \"Bertrand Muslin\",              \"id\": \"511523108\"            }          ]        },        \"message\": \"bn aniv BBR!!\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/511523108/posts/10152407790508109\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/511523108/posts/10152407790508109\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"status\",        \"status_type\": \"wall_post\",        \"created_time\": \"2014-04-13T22:00:13+0000\",        \"updated_time\": \"2014-04-13T22:00:13+0000\"      },      {        \"id\": \"1454571979_10203038482070364\",        \"from\": {          \"name\": \"Melissa Moua\",          \"id\": \"532398393\"        },        \"message\": \"C partiiiiiieeee mn kikiiiiii 12h de route hiii sa fai mal sa fai mal lets go\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/1454571979/posts/10203038482070364\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/1454571979/posts/10203038482070364\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"status\",        \"status_type\": \"mobile_status_update\",        \"application\": {          \"name\": \"Facebook for Android\",          \"namespace\": \"fbandroid\",          \"id\": \"350685531728\"        },        \"created_time\": \"2014-04-13T21:44:30+0000\",        \"updated_time\": \"2014-04-13T21:44:30+0000\",        \"likes\": {          \"data\": [            {              \"id\": \"726988850\",              \"name\": \"Julicia Techer\"            }          ],          \"paging\": {            \"cursors\": {              \"after\": \"NzI2OTg4ODUw\",              \"before\": \"NzI2OTg4ODUw\"            }          }        }      },      {        \"id\": \"636372817_10152780304502818\",        \"from\": {          \"name\": \"Audrey Ct\",          \"id\": \"545433411\"        },        \"to\": {          \"data\": [            {              \"name\": \"Martin Pousson\",              \"id\": \"636372817\"            }          ]        },        \"message\": \"Fait pas la gueule pousson !!!!!!\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/636372817/posts/10152780304502818\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/636372817/posts/10152780304502818\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"status\",        \"status_type\": \"wall_post\",        \"application\": {          \"name\": \"Facebook for iPhone\",          \"namespace\": \"fbiphone\",          \"id\": \"6628568379\"        },        \"created_time\": \"2014-04-13T21:39:35+0000\",        \"updated_time\": \"2014-04-14T05:24:07+0000\",        \"likes\": {          \"data\": [            {              \"id\": \"1405332120\",              \"name\": \"Gat Dbr\"            },            {              \"id\": \"581390356\",              \"name\": \"Paul Ablard\"            }          ],          \"paging\": {            \"cursors\": {              \"after\": \"NTgxMzkwMzU2\",              \"before\": \"MTQwNTMzMjEyMA==\"            }          }        },        \"comments\": {          \"data\": [            {              \"id\": \"10152780304502818_37143062\",              \"from\": {                \"name\": \"Frederic Dupret\",                \"id\": \"545433411\"              },              \"message\": \"Il va falloir t habituer l ann�e prochaine sans Zlatan �a va �tre pareil � chaque journ�e du championnat\",              \"can_remove\": false,              \"created_time\": \"2014-04-14T04:17:05+0000\",              \"like_count\": 0,              \"user_likes\": false            },            {              \"id\": \"10152780304502818_37143510\",              \"from\": {                \"name\": \"Martin Pousson\",                \"id\": \"636372817\"              },              \"message\": \"�a n'emp�chera pas d'�tre champion!\",              \"can_remove\": false,              \"created_time\": \"2014-04-14T05:20:55+0000\",              \"like_count\": 1,              \"user_likes\": false            },            {              \"id\": \"10152780304502818_37143518\",              \"from\": {                \"name\": \"Audrey Ct\",                \"id\": \"515770900\"              },              \"message\": \"Fait gaff a toi le Week end prochain mon pousse !!!!\",              \"can_remove\": false,              \"created_time\": \"2014-04-14T05:21:57+0000\",              \"like_count\": 0,              \"user_likes\": false            },            {              \"id\": \"10152780304502818_37143536\",              \"from\": {                \"name\": \"Martin Pousson\",                \"id\": \"545433411\"              },              \"message\": \"LOL\",              \"can_remove\": false,              \"created_time\": \"2014-04-14T05:24:07+0000\",              \"like_count\": 0,              \"user_likes\": false            }          ],          \"paging\": {            \"cursors\": {              \"after\": \"NA==\",              \"before\": \"MQ==\"            }          }        }      },      {        \"id\": \"1628467266_10202920633210013\",        \"from\": {          \"name\": \"Sam Lester\",          \"id\": \"100004225685584\"        },        \"to\": {          \"data\": [            {              \"name\": \"Romain Guion\",              \"id\": \"1628467266\"            }          ]        },        \"message\": \"Joyeux anniversaire Couderc !\\nMiss you !!!\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/1628467266/posts/10202920633210013\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/1628467266/posts/10202920633210013\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"status\",        \"status_type\": \"wall_post\",        \"created_time\": \"2014-04-13T20:54:12+0000\",        \"updated_time\": \"2014-04-13T20:54:12+0000\"      },      {        \"id\": \"100000099709647_794686383878011\",        \"from\": {          \"name\": \"Estelle Vl�\",          \"id\": \"100000099709647\"        },        \"story\": \"Estelle Vl� shared a link.\",        \"picture\": \"https://fbexternal-a.akamaihd.net/safe_image.php?d=AQBolSX0RM-jlaTt&w=154&h=154&url=http%3A%2F%2Fyoupomm.com%2Fimg%2Fimg-share.jpg\",        \"link\": \"http://youpomm.com/\",        \"name\": \"YOUPOMM\",        \"caption\": \"youpomm.com\",        \"description\": \"Sur Youpomm, tous tes fruitasmes sont possibles. Clique pour d�couvrir les derni�res vid�os sexfruits. #EffetPapayon\",        \"icon\": \"https://fbstatic-a.akamaihd.net/rsrc.php/v2/yD/r/aS8ecmYRys0.gif\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/100000099709647/posts/794686383878011\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/100000099709647/posts/794686383878011\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"link\",        \"status_type\": \"shared_story\",        \"application\": {          \"name\": \"Facebook for iPhone\",          \"namespace\": \"fbiphone\",          \"id\": \"6628568379\"        },        \"created_time\": \"2014-04-13T20:44:31+0000\",        \"updated_time\": \"2014-04-13T20:44:31+0000\"      },      {        \"id\": \"1333597192_10203951471410495\",        \"from\": {          \"name\": \"Mag Ali\",          \"id\": \"1217232668\"        },        \"to\": {          \"data\": [            {              \"name\": \"Clarisse Montfort\",              \"id\": \"1333597192\"            }          ]        },        \"message\": \"Heureux anniversaire Clarisse! \",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/1333597192/posts/10203951471410495\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/1333597192/posts/10203951471410495\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"status\",        \"status_type\": \"wall_post\",        \"created_time\": \"2014-04-13T19:37:51+0000\",        \"updated_time\": \"2014-04-13T19:37:51+0000\"      },      {        \"id\": \"511523108_10152407227218109\",        \"from\": {          \"name\": \"Alex Pardi\",          \"id\": \"789100371\"        },        \"to\": {          \"data\": [            {              \"name\": \"Bertrand Muslin\",              \"id\": \"511523108\"            }          ]        },        \"message\": \"joyeux anniversaire pour un joyeux hareng\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/511523108/posts/10152407227218109\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/511523108/posts/10152407227218109\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"status\",        \"status_type\": \"wall_post\",        \"created_time\": \"2014-04-13T17:57:51+0000\",        \"updated_time\": \"2014-04-13T17:57:51+0000\",        \"likes\": {          \"data\": [            {              \"id\": \"1222813383\",              \"name\": \"Cam�lia Bouf\"            }          ],          \"paging\": {            \"cursors\": {              \"after\": \"MTIyMjgxMzM4Mw==\",              \"before\": \"MTIyMjgxMzM4Mw==\"            }          }        }      },      {        \"id\": \"576458912_10152352882793913\",        \"from\": {          \"name\": \"Anne Dbf\",          \"id\": \"576458912\"        },        \"story\": \"Anne Dbf added 2 new photos.\",        \"picture\": \"https://fbcdn-photos-g-a.akamaihd.net/hphotos-ak-prn2/t1.0-0/1544339_10152352916348913_4829656996270740133_s.jpg\",        \"link\": \"https://www.facebook.com/photo.php?fbid=10152352916348913&set=a.10150364611278913.366991.576458912&type=1&relevant_count=2\",        \"icon\": \"https://fbstatic-a.akamaihd.net/rsrc.php/v2/yx/r/og8V99JVf8G.gif\",        \"privacy\": {          \"value\": \"\"        },        \"type\": \"photo\",        \"status_type\": \"added_photos\",        \"object_id\": \"10152352916348913\",        \"application\": {          \"name\": \"Facebook for iPhone\",          \"namespace\": \"fbiphone\",          \"id\": \"6628568379\"        },        \"created_time\": \"2014-04-13T16:51:33+0000\",        \"updated_time\": \"2014-04-13T16:51:33+0000\"      },      {        \"id\": \"644769534_10152752250714535\",        \"from\": {          \"name\": \"Sophie Meyer\",          \"id\": \"644769534\"        },        \"to\": {          \"data\": [            {              \"name\": \"Lucie Mariel\",              \"id\": \"1040048672\"            },            {              \"name\": \"Jan Asselberghs\",              \"id\": \"640351752\"            },            {              \"name\": \"Sophie Meyer\",              \"id\": \"644769534\"            }          ]        },        \"with_tags\": {          \"data\": [            {              \"name\": \"Lucie Mariel\",              \"id\": \"1040048672\"            },            {              \"name\": \"Jan Asselberghs\",              \"id\": \"640351752\"            },            {              \"name\": \"Sophie Meyer\",              \"id\": \"644769534\"            }          ]        },        \"story\": \"Sophie Meyer added 11 photos.\",        \"picture\": \"https://fbcdn-photos-d-a.akamaihd.net/hphotos-ak-frc3/t1.0-0/10259734_10152752248879535_6140110012910477253_s.jpg\",        \"link\": \"https://www.facebook.com/photo.php?fbid=10152752248879535&set=pcb.10152752250714535&type=1&relevant_count=9\",        \"icon\": \"https://fbstatic-a.akamaihd.net/rsrc.php/v2/yx/r/og8V99JVf8G.gif\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/644769534/posts/10152752250714535\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/644769534/posts/10152752250714535\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"place\": {          \"id\": \"114885670293\",          \"name\": \"Brussels\",          \"location\": {            \"street\": \"2-4 rue Royale\",            \"city\": \"Brussels\",            \"state\": \"\",            \"country\": \"Belgium\",            \"zip\": \"1000\",            \"latitude\": 50.850589829472,            \"longitude\": 4.3497597362824          }        },        \"type\": \"photo\",        \"status_type\": \"mobile_status_update\",        \"object_id\": \"10152752248879535\",        \"application\": {          \"name\": \"Facebook for iPhone\",          \"namespace\": \"fbiphone\",          \"id\": \"6628568379\"        },        \"created_time\": \"2014-04-13T15:47:43+0000\",        \"updated_time\": \"2014-04-13T15:47:43+0000\",        \"likes\": {          \"data\": [            {              \"id\": \"780685654\",              \"name\": \"Aur�lie Hacot\"            },            {              \"id\": \"1460794909\",              \"name\": \"Marta Szeflinska\"            },            {              \"id\": \"1560694522\",              \"name\": \"Radek LA\"            },            {              \"id\": \"1627518681\",              \"name\": \"Arnaud Pignerol\"            },            {              \"id\": \"100002327937842\",              \"name\": \"Tissame Farssi\"            },            {              \"id\": \"100000538659434\",              \"name\": \"Simona Padvaiskait?\"            }          ],          \"paging\": {            \"cursors\": {              \"after\": \"MTAwMDAwNTM4NjU5NDM0\",              \"before\": \"NzgwNjg1NjU0\"            }          }        }      },      {        \"id\": \"1454571979_10203035616878736\",        \"from\": {          \"name\": \"Melissa Moua\",          \"id\": \"1454571979\"        },        \"message\": \"Une nouvelle arrivante a la maison :) :)\",        \"story\": \"Melissa Moua added 5 photos.\",        \"picture\": \"https://fbcdn-photos-c-a.akamaihd.net/hphotos-ak-prn2/t1.0-0/10262177_10203035609958563_202350297523897736_s.jpg\",        \"link\": \"https://www.facebook.com/photo.php?fbid=10203035609958563&set=pcb.10203035616878736&type=1&relevant_count=5\",        \"icon\": \"https://fbstatic-a.akamaihd.net/rsrc.php/v2/yx/r/og8V99JVf8G.gif\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/1454571979/posts/10203035616878736\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/1454571979/posts/10203035616878736\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"photo\",        \"status_type\": \"mobile_status_update\",        \"object_id\": \"10203035609958563\",        \"application\": {          \"name\": \"Facebook for Android\",          \"namespace\": \"fbandroid\",          \"id\": \"350685531728\"        },        \"created_time\": \"2014-04-13T14:38:45+0000\",        \"updated_time\": \"2014-04-13T14:38:45+0000\",        \"likes\": {          \"data\": [            {              \"id\": \"1022542019\",              \"name\": \"Karine Bountyy\"            },            {              \"id\": \"1544422106\",              \"name\": \"Mathilde Monti\"            },            {              \"id\": \"1367167268\",              \"name\": \"Hally Mamut\"            },            {              \"id\": \"1066821726\",              \"name\": \"Vanessa Bountyy\"            },            {              \"id\": \"100000932329627\",              \"name\": \"Oph�lie Henry\"            },            {              \"id\": \"100000984183383\",              \"name\": \"L�o Monti\"            },            {              \"id\": \"726988850\",              \"name\": \"Julicia Techer\"            },            {              \"id\": \"1313209914\",              \"name\": \"Isabelle Vacher\"            },            {              \"id\": \"1454571979\",              \"name\": \"Melissa Moua\"            }          ],          \"paging\": {            \"cursors\": {              \"after\": \"MTQ1NDU3MTk3OQ==\",              \"before\": \"MTAyMjU0MjAxOQ==\"            }          }        }      },      {        \"id\": \"853920223_10154017388025224\",        \"from\": {          \"name\": \"Hortense B�thune\",          \"id\": \"853920223\"        },        \"to\": {          \"data\": [            {              \"name\": \"Domi Cb\",              \"id\": \"851799580\"            }          ]        },        \"with_tags\": {          \"data\": [            {              \"name\": \"Domi Cb\",              \"id\": \"851799580\"            }          ]        },        \"message\": \"Dimanche forc�ment tr�s productif par 30* !!!\",        \"story\": \"Hortense B�thune added 5 photos.\",        \"picture\": \"https://fbcdn-photos-d-a.akamaihd.net/hphotos-ak-prn1/t1.0-0/10253917_10154017384005224_4673790988550327120_s.jpg\",        \"link\": \"https://www.facebook.com/photo.php?fbid=10154017384005224&set=pcb.10154017388025224&type=1&relevant_count=5\",        \"icon\": \"https://fbstatic-a.akamaihd.net/rsrc.php/v2/yx/r/og8V99JVf8G.gif\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/853920223/posts/10154017388025224\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/853920223/posts/10154017388025224\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"place\": {          \"id\": \"182566901835636\",          \"name\": \"West Lake, Hanoi, Vietnam\",          \"location\": {            \"street\": \"\",            \"city\": \"Hanoi\",            \"state\": \"\",            \"country\": \"Vietnam\",            \"zip\": \"\",            \"latitude\": 21.043983225559,            \"longitude\": 105.83661227946          }        },        \"type\": \"photo\",        \"status_type\": \"mobile_status_update\",        \"object_id\": \"10154017384005224\",        \"application\": {          \"name\": \"Facebook for iPhone\",          \"namespace\": \"fbiphone\",          \"id\": \"6628568379\"        },        \"created_time\": \"2014-04-13T13:27:09+0000\",        \"updated_time\": \"2014-04-13T13:27:09+0000\",        \"likes\": {          \"data\": [            {              \"id\": \"1079280355\",              \"name\": \"Vi?t L� Ho�ng\"            },            {              \"id\": \"815664434\",              \"name\": \"Romain B�thune\"            },            {              \"id\": \"851799580\",              \"name\": \"Domi Cb\"            },            {              \"id\": \"709245419\",              \"name\": \"Auriane van der Farn\"            },            {              \"id\": \"1363594082\",              \"name\": \"Camille Herr\"            },            {              \"id\": \"1203702230\",              \"name\": \"Cl�mence De Chasi-Mabard\"            },            {              \"id\": \"663006438\",              \"name\": \"Petit Jean\"            }          ],          \"paging\": {            \"cursors\": {              \"after\": \"NjYzMDA2NDM4\",              \"before\": \"MTA3OTI4MDM1NQ==\"            }          }        }      },      {        \"id\": \"511523108_10152406756778109\",        \"from\": {          \"name\": \"Paul Ethanol\",          \"id\": \"667242125\"        },        \"to\": {          \"data\": [            {              \"name\": \"Bertrand Muslin\",              \"id\": \"511523108\"            }          ]        },        \"message\": \"C'est la f�te du Muesli. Bon anniversaire\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/511523108/posts/10152406756778109\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/511523108/posts/10152406756778109\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"status\",        \"status_type\": \"wall_post\",        \"created_time\": \"2014-04-13T13:18:58+0000\",        \"updated_time\": \"2014-04-13T13:18:58+0000\"      },      {        \"id\": \"570423805_10152068439723806\",        \"from\": {          \"name\": \"Valentin La Corbe\",          \"id\": \"570423805\"        },        \"message\": \"Quelle minute de silence a Anfield!\\nMagnifique\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/570423805/posts/10152068439723806\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/570423805/posts/10152068439723806\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"status\",        \"status_type\": \"mobile_status_update\",        \"application\": {          \"name\": \"Facebook for iPhone\",          \"namespace\": \"fbiphone\",          \"id\": \"6628568379\"        },        \"created_time\": \"2014-04-13T12:42:11+0000\",        \"updated_time\": \"2014-04-13T12:44:48+0000\",        \"likes\": {          \"data\": [            {              \"id\": \"710397189\",              \"name\": \"Nathan Corbo\"            },            {              \"id\": \"1394172188\",              \"name\": \"Romain Bonansea\"            },            {              \"id\": \"636372817\",              \"name\": \"Martin Pousson\"            }          ],          \"paging\": {            \"cursors\": {              \"after\": \"NjM2MzcyODE3\",              \"before\": \"NzEwMzk3MTg5\"            }          }        },        \"comments\": {          \"data\": [            {              \"id\": \"10152068439723806_300473257\",              \"from\": {                \"name\": \"Valentin La Corbe\",                \"id\": \"570423805\"              },              \"message\": \"ca commence bien! kompany et hart a la rue\",              \"can_remove\": false,              \"created_time\": \"2014-04-13T12:44:48+0000\",              \"like_count\": 0,              \"user_likes\": false            }          ],          \"paging\": {            \"cursors\": {              \"after\": \"MQ==\",              \"before\": \"MQ==\"            }          }        }      },      {        \"id\": \"511523108_10152406667648109\",        \"from\": {          \"name\": \"Cam�lia Bouf\",          \"id\": \"1222813383\"        },        \"to\": {          \"data\": [            {              \"name\": \"Bertrand Muslin\",              \"id\": \"511523108\"            }          ]        },        \"message\": \"Joyeux anniversaire Bert ! Gros bisous ! \",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/511523108/posts/10152406667648109\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/511523108/posts/10152406667648109\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"status\",        \"status_type\": \"wall_post\",        \"application\": {          \"name\": \"Facebook for iPhone\",          \"namespace\": \"fbiphone\",          \"id\": \"6628568379\"        },        \"created_time\": \"2014-04-13T12:16:37+0000\",        \"updated_time\": \"2014-04-13T12:16:37+0000\"      },      {        \"id\": \"511523108_10152406574763109\",        \"from\": {          \"name\": \"Benoit Oberbach\",          \"id\": \"780859928\"        },        \"to\": {          \"data\": [            {              \"name\": \"Bertrand Muslin\",              \"id\": \"511523108\"            }          ]        },        \"message\": \"Happy B-day ma poule !!! Profites bien. A tr�s vite jspr\",        \"actions\": [          {            \"name\": \"Comment\",            \"link\": \"https://www.facebook.com/511523108/posts/10152406574763109\"          },          {            \"name\": \"Like\",            \"link\": \"https://www.facebook.com/511523108/posts/10152406574763109\"          }        ],        \"privacy\": {          \"value\": \"\"        },        \"type\": \"status\",        \"status_type\": \"wall_post\",        \"application\": {          \"name\": \"Facebook for iPhone\",          \"namespace\": \"fbiphone\",          \"id\": \"6628568379\"        },        \"created_time\": \"2014-04-13T11:15:11+0000\",        \"updated_time\": \"2014-04-13T11:15:11+0000\",        \"likes\": {          \"data\": [            {              \"id\": \"511523108\",              \"name\": \"Bertrand Muslin\"            }          ],          \"paging\": {            \"cursors\": {              \"after\": \"NTExNTIzMTA4\",              \"before\": \"NTExNTIzMTA4\"            }          }        }      },      {        \"id\": \"555785961_10152419589030962\",        \"from\": {          \"name\": \"Maud Gilliard\",          \"id\": \"555785961\"        },        \"story\": \"Maud Gilliard added 2 new photos.\",        \"picture\": \"https://fbcdn-photos-e-a.akamaihd.net/hphotos-ak-ash3/t1.0-0/1901804_10152420854505962_5535805458645118896_s.jpg\",        \"link\": \"https://www.facebook.com/photo.php?fbid=10152420854505962&set=a.491383985961.300449.555785961&type=1&relevant_count=2\",        \"icon\": \"https://fbstatic-a.akamaihd.net/rsrc.php/v2/yx/r/og8V99JVf8G.gif\",        \"privacy\": {          \"value\": \"\"        },        \"type\": \"photo\",        \"status_type\": \"added_photos\",        \"object_id\": \"10152420854505962\",        \"application\": {          \"name\": \"Facebook for iPhone\",          \"namespace\": \"fbiphone\",          \"id\": \"6628568379\"        },        \"created_time\": \"2014-04-13T10:40:07+0000\",        \"updated_time\": \"2014-04-13T10:40:07+0000\"      },      {        \"id\": \"1454571979_10203032839809311\",        \"from\": {          \"name\": \"Melissa Moua\",          \"id\": \"1454571979\"        },        \"story\": \"Melissa Moua added 2 new photos.\",        \"picture\": \"https://fbcdn-photos-e-a.akamaihd.net/hphotos-ak-prn2/t1.0-0/1538885_10203038405668454_7028272728560982494_s.jpg\",        \"link\": \"https://www.facebook.com/photo.php?fbid=10203038405668454&set=a.10200434343008515.1073741826.1454571979&type=1&relevant_count=2\",        \"icon\": \"https://fbstatic-a.akamaihd.net/rsrc.php/v2/yx/r/og8V99JVf8G.gif\",        \"privacy\": {          \"value\": \"\"        },        \"type\": \"photo\",        \"status_type\": \"added_photos\",        \"object_id\": \"10203038405668454\",        \"application\": {          \"name\": \"Facebook for Android\",          \"namespace\": \"fbandroid\",          \"id\": \"350685531728\"        },        \"created_time\": \"2014-04-13T02:24:57+0000\",        \"updated_time\": \"2014-04-13T02:24:57+0000\"      }    ],    \"paging\": {      \"previous\": \"https://graph.facebook.com/100000420201795/home?limit=25&since=1397457039\",      \"next\": \"https://graph.facebook.com/100000420201795/home?limit=25&until=1397355896\"    }  }}");
                User fbMe = TheModelFactory.ParseFullUser(result, client);
               
               
                User me = fbMe;


                User dbMe = TheRepository.GetFullUser(TheRepository.GetUserIdFromFacebookId(fbMe.FacebookId));
                if (dbMe != null)
                {
                    List<User> newFriends = new List<User>();
                    foreach (var friend in fbMe.Friends)
                    {
                        var dbfriends = dbMe.Friends.Where(f => f.FacebookId == friend.FacebookId);

                        if (dbfriends.Count() == 0)
                        {
                            int newFriendId = TheRepository.GetUserIdFromFacebookId(friend.FacebookId);
                            if (newFriendId>0)
                                newFriends.Add(TheRepository.GetFullUser(newFriendId));
                        }

                    }
                    me = _facebookToDBUpdater.ParseFullUser(dbMe, fbMe, newFriends);
                }

                foreach (var friend in me.Friends)
                {
                    TheRepository.SaveUser(friend);
                    foreach (var post in friend.Posts)
                    {
                        post.UserId = friend.Id;
                        TheRepository.SavePost(post);
                    }
                }
                TheRepository.SaveFullUser(me);
                


                return Request.CreateResponse(HttpStatusCode.Created, "News feed has been saved");

            }
            catch (Exception ex)
            {
                return Request.CreateErrorResponse(HttpStatusCode.BadRequest, ex);
            }
        }

    }
}
